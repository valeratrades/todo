env:
  CARGO_INCREMENTAL: '0'
  CARGO_NET_RETRY: '10'
  RUSTUP_MAX_RETRIES: '10'
  RUST_BACKTRACE: short
jobs:
  load_nix:
    runs-on: ubuntu-latest
    steps:
    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main
    - name: Setup Nix cache
      uses: DeterminateSystems/magic-nix-cache-action@main
    - name: Cache packages
      run: '# Pre-fetch packages into nix store so they''re cached for dependent jobs

        # Use nix-shell which properly sets up env vars like PKG_CONFIG_PATH

        nix-shell -p mold openssl openssl.dev egl-wayland wayland libGL libgbm pkg-config
        --run "echo packages cached"

        '
  pre_ci:
    uses: valeratrades/.github/.github/workflows/pre_ci.yml@master
  rust-tests:
    if: needs.pre_ci.outputs.continue
    name: Rust ${{matrix.rust}}
    needs:
    - load_nix
    - pre_ci
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@main
    - name: Restore Nix cache
      uses: DeterminateSystems/magic-nix-cache-action@main
    - uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{matrix.rust}}
    - name: Install mold
      uses: rui314/setup-mold@v1
    - if: github.ref == 'refs/heads/release'
      name: Set RUSTFLAGS for release branch
      run: echo "RUSTFLAGS=-Dwarnings" >> $GITHUB_ENV
    - if: matrix.rust == 'nightly'
      name: Enable type layout randomization
      run: echo RUSTFLAGS=${RUSTFLAGS}\ -Zrandomize-layout\ --cfg=exhaustive >> $GITHUB_ENV
    - name: Download modified by pre-ci Cargo.toml files
      uses: actions/download-artifact@v4
      with:
        name: modified-cargo-files
    - run: 'nix-shell -p mold openssl openssl.dev egl-wayland wayland libGL libgbm
        pkg-config --command "export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>''
        -A mold --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\" && export
        LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A openssl --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A openssl.dev --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A egl-wayland --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A wayland --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A libGL --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A libgbm --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A pkg-config --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && echo DEBUG: LD_LIBRARY_PATH=\$LD_LIBRARY_PATH && cargo update"'
    - run: 'nix-shell -p mold openssl openssl.dev egl-wayland wayland libGL libgbm
        pkg-config --command "export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>''
        -A mold --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\" && export
        LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A openssl --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A openssl.dev --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A egl-wayland --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A wayland --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A libGL --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A libgbm --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A pkg-config --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && echo DEBUG: LD_LIBRARY_PATH=\$LD_LIBRARY_PATH && cargo check"'
    - run: 'nix-shell -p mold openssl openssl.dev egl-wayland wayland libGL libgbm
        pkg-config --command "export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>''
        -A mold --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\" && export
        LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A openssl --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A openssl.dev --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A egl-wayland --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A wayland --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A libGL --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A libgbm --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && export LD_LIBRARY_PATH=\"\$(nix-build ''<nixpkgs>'' -A pkg-config --no-out-link)/lib\${LD_LIBRARY_PATH:+:}\$LD_LIBRARY_PATH\"
        && echo DEBUG: LD_LIBRARY_PATH=\$LD_LIBRARY_PATH && cargo test"'
    strategy:
      fail-fast: false
      matrix:
        rust:
        - nightly
        - nightly-2025-08-01
    timeout-minutes: 45
name: Errors
'on':
  pull_request: {}
  push: {}
  workflow_dispatch: {}
permissions:
  contents: read
